<div class="character-creator-container">
  <mat-card class="creator-header">
    <mat-card-header>
      <mat-card-title>Création de Personnage - La Légende des 5 Anneaux</mat-card-title>
      <mat-card-subtitle>Points d'Expérience disponibles: {{ availableXP() }}</mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <div class="creator-content">
    <!-- Étape 1: Informations de base -->
    <mat-card *ngIf="currentStep() === 1">
      <mat-card-header>
        <mat-card-title>1. Informations de Base</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field>
            <mat-label>Nom du personnage</mat-label>
            <input matInput 
                   [value]="character().name || ''" 
                   (input)="updateBasicInfo('name', $any($event.target).value)">
          </mat-form-field>
          
          <mat-form-field>
            <mat-label>Âge</mat-label>
            <input matInput 
                   type="number" 
                   [value]="character().age || 15" 
                   (input)="updateBasicInfo('age', +$any($event.target).value)">
          </mat-form-field>
          
          <mat-form-field>
            <mat-label>Genre</mat-label>
            <mat-select [value]="character().gender || ''" 
                       (selectionChange)="updateBasicInfo('gender', $event.value)">
              <mat-option value="masculin">Masculin</mat-option>
              <mat-option value="féminin">Féminin</mat-option>
              <mat-option value="autre">Autre</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-raised-button color="primary" (click)="nextStep()">Suivant</button>
      </mat-card-actions>
    </mat-card>

    <!-- Étape 2: Choix du Clan -->
    <mat-card *ngIf="currentStep() === 2">
      <mat-card-header>
        <mat-card-title>2. Choix du Clan</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="clan-selection-container">
          <div class="clan-selection">
            <mat-card 
              *ngFor="let clan of availableClans(); trackBy: trackByClanName"
              class="clan-card" 
              [class.selected]="character().clan === clan.name"
              (click)="selectClan(clan.name)">
              <mat-card-header>
                <mat-card-title>{{ clan.name }}</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <p>{{ clan.description }}</p>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="previousStep()">Précédent</button>
        <button mat-raised-button color="primary" 
                [disabled]="!character().clan" 
                (click)="nextStep()">Suivant</button>
      </mat-card-actions>
    </mat-card>

    <!-- Étape 3: Choix de la Famille -->
    <mat-card *ngIf="currentStep() === 3">
      <mat-card-header>
        <mat-card-title>3. Choix de la Famille</mat-card-title>
        <mat-card-subtitle>Clan sélectionné: {{ character().clan }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="family-selection">
          <mat-card 
            *ngFor="let family of availableFamilies(); trackBy: trackByFamilyName"
            class="family-card" 
            [class.selected]="character().family === family.name"
            (click)="selectFamily(family.name)">
            <mat-card-header>
              <mat-card-title>{{ family.name }}</mat-card-title>
              <mat-card-subtitle>Bonus: +1 {{ family.traitBonus | titlecase }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <p>{{ family.description }}</p>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="previousStep()">Précédent</button>
        <button mat-raised-button color="primary" 
                [disabled]="!character().family" 
                (click)="nextStep()">Suivant</button>
      </mat-card-actions>
    </mat-card>

    <!-- Étape 4: Choix de l'École -->
    <mat-card *ngIf="currentStep() === 4">
      <mat-card-header>
        <mat-card-title>4. Choix de l'École</mat-card-title>
        <mat-card-subtitle>{{ character().clan }} - {{ character().family }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="school-selection">
          <mat-card 
            *ngFor="let school of availableSchools(); trackBy: trackBySchoolName"
            class="school-card" 
            [class.selected]="character().school === school.name"
            (click)="selectSchool(school.name)">
            <mat-card-header>
              <mat-card-title>{{ school.name }}</mat-card-title>
              <mat-card-subtitle>{{ school.type | titlecase }} - Bonus: +1 {{ school.traitBonus | titlecase }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <p><strong>Honneur de départ:</strong> {{ school.honor }}</p>
              <p><strong>Compétences:</strong></p>
              <mat-chip-set>
                <mat-chip *ngFor="let skill of school.skills">{{ skill }}</mat-chip>
              </mat-chip-set>
              <p><strong>Technique:</strong> {{ school.technique }}</p>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="previousStep()">Précédent</button>
        <button mat-raised-button color="primary" 
                [disabled]="!character().school" 
                (click)="nextStep()">Suivant</button>
      </mat-card-actions>
    </mat-card>

    <!-- Étape 5: Personnalisation avec XP -->
    <mat-card *ngIf="currentStep() === 5">
      <mat-card-header>
        <mat-card-title>5. Personnalisation</mat-card-title>
        <mat-card-subtitle>Points d'XP restants: {{ availableXP() }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <mat-tab-group>
          <!-- Onglet Anneaux -->
          <mat-tab label="Anneaux">
            <div class="tab-content">
              <p class="info-text">Les Anneaux sont calculés automatiquement d'après les Traits, sauf le Vide.</p>
              <div class="rings-grid">
                <div class="ring-item">
                  <span>Terre:</span>
                  <span class="value">{{ calculatedRings().terre }}</span>
                  <span class="formula">(min Constitution/Volonté)</span>
                </div>
                <div class="ring-item">
                  <span>Eau:</span>
                  <span class="value">{{ calculatedRings().eau }}</span>
                  <span class="formula">(min Force/Perception)</span>
                </div>
                <div class="ring-item">
                  <span>Air:</span>
                  <span class="value">{{ calculatedRings().air }}</span>
                  <span class="formula">(min Réflexes/Intuition)</span>
                </div>
                <div class="ring-item">
                  <span>Feu:</span>
                  <span class="value">{{ calculatedRings().feu }}</span>
                  <span class="formula">(min Agilité/Intelligence)</span>
                </div>
                <div class="ring-item">
                  <span>Vide:</span>
                  <span class="value">{{ calculatedRings().vide }}</span>
                  <div class="trait-buttons">
                    <button mat-button 
                            [disabled]="calculatedRings().vide <= 2"
                            (click)="decreaseVoidRing()"
                            matTooltip="Diminuer le Vide">
                      -
                    </button>
                    <button mat-button 
                            [disabled]="!canAfford(getVoidRingCost(calculatedRings().vide)) || isAtMaximum(calculatedRings().vide)"
                            (click)="improveVoidRing()"
                            matTooltip="Améliorer le Vide">
                      +
                    </button>
                  </div>
                  <span class="cost">({{ getVoidRingCost(calculatedRings().vide) }} XP)</span>
                </div>
              </div>
            </div>
          </mat-tab>

          <!-- Onglet Traits par Anneaux -->
          <mat-tab label="Traits">
            <div class="tab-content">
              <div class="traits-by-rings-editor">
                <!-- Terre -->
                <div class="ring-traits-group">
                  <h4>Terre</h4>
                  <div class="traits-ring-grid">
                    <div class="trait-item">
                      <span>Constitution:</span>
                      <span class="value">{{ getTraitValue('constitution') }}</span>
                      <div class="trait-buttons">
                        <button mat-button 
                                [disabled]="getTraitValue('constitution') <= 2"
                                (click)="decreaseTrait('constitution')"
                                matTooltip="Diminuer Constitution">
                          -
                        </button>
                        <button mat-button 
                                [disabled]="!canAfford(getTraitCost(getTraitValue('constitution'))) || isAtMaximum(getTraitValue('constitution'))"
                                (click)="improveTrait('constitution')"
                                matTooltip="Améliorer Constitution">
                          +
                        </button>
                      </div>
                      <span class="cost">({{ getTraitCost(getTraitValue('constitution')) }} XP)</span>
                    </div>
                    <div class="trait-item">
                      <span>Volonté:</span>
                      <span class="value">{{ getTraitValue('volonte') }}</span>
                      <div class="trait-buttons">
                        <button mat-button 
                                [disabled]="getTraitValue('volonte') <= 2"
                                (click)="decreaseTrait('volonte')"
                                matTooltip="Diminuer Volonté">
                          -
                        </button>
                        <button mat-button 
                                [disabled]="!canAfford(getTraitCost(getTraitValue('volonte'))) || isAtMaximum(getTraitValue('volonte'))"
                                (click)="improveTrait('volonte')"
                                matTooltip="Améliorer Volonté">
                          +
                        </button>
                      </div>
                      <span class="cost">({{ getTraitCost(getTraitValue('volonte')) }} XP)</span>
                    </div>
                  </div>
                </div>

                <!-- Eau -->
                <div class="ring-traits-group">
                  <h4>Eau</h4>
                  <div class="traits-ring-grid">
                    <div class="trait-item">
                      <span>Force:</span>
                      <span class="value">{{ getTraitValue('force') }}</span>
                      <div class="trait-buttons">
                        <button mat-button 
                                [disabled]="getTraitValue('force') <= 2"
                                (click)="decreaseTrait('force')"
                                matTooltip="Diminuer Force">
                          -
                        </button>
                        <button mat-button 
                                [disabled]="!canAfford(getTraitCost(getTraitValue('force'))) || isAtMaximum(getTraitValue('force'))"
                                (click)="improveTrait('force')"
                                matTooltip="Améliorer Force">
                          +
                        </button>
                      </div>
                      <span class="cost">({{ getTraitCost(getTraitValue('force')) }} XP)</span>
                    </div>
                    <div class="trait-item">
                      <span>Perception:</span>
                      <span class="value">{{ getTraitValue('perception') }}</span>
                      <div class="trait-buttons">
                        <button mat-button 
                                [disabled]="getTraitValue('perception') <= 2"
                                (click)="decreaseTrait('perception')"
                                matTooltip="Diminuer Perception">
                          -
                        </button>
                        <button mat-button 
                                [disabled]="!canAfford(getTraitCost(getTraitValue('perception'))) || isAtMaximum(getTraitValue('perception'))"
                                (click)="improveTrait('perception')"
                                matTooltip="Améliorer Perception">
                          +
                        </button>
                      </div>
                      <span class="cost">({{ getTraitCost(getTraitValue('perception')) }} XP)</span>
                    </div>
                  </div>
                </div>

                <!-- Air -->
                <div class="ring-traits-group">
                  <h4>Air</h4>
                  <div class="traits-ring-grid">
                    <div class="trait-item">
                      <span>Réflexes:</span>
                      <span class="value">{{ getTraitValue('reflexes') }}</span>
                      <div class="trait-buttons">
                        <button mat-button 
                                [disabled]="getTraitValue('reflexes') <= 2"
                                (click)="decreaseTrait('reflexes')"
                                matTooltip="Diminuer Réflexes">
                          -
                        </button>
                        <button mat-button 
                                [disabled]="!canAfford(getTraitCost(getTraitValue('reflexes'))) || isAtMaximum(getTraitValue('reflexes'))"
                                (click)="improveTrait('reflexes')"
                                matTooltip="Améliorer Réflexes">
                          +
                        </button>
                      </div>
                      <span class="cost">({{ getTraitCost(getTraitValue('reflexes')) }} XP)</span>
                    </div>
                    <div class="trait-item">
                      <span>Intuition:</span>
                      <span class="value">{{ getTraitValue('intuition') }}</span>
                      <div class="trait-buttons">
                        <button mat-button 
                                [disabled]="getTraitValue('intuition') <= 2"
                                (click)="decreaseTrait('intuition')"
                                matTooltip="Diminuer Intuition">
                          -
                        </button>
                        <button mat-button 
                                [disabled]="!canAfford(getTraitCost(getTraitValue('intuition'))) || isAtMaximum(getTraitValue('intuition'))"
                                (click)="improveTrait('intuition')"
                                matTooltip="Améliorer Intuition">
                          +
                        </button>
                      </div>
                      <span class="cost">({{ getTraitCost(getTraitValue('intuition')) }} XP)</span>
                    </div>
                  </div>
                </div>

                <!-- Feu -->
                <div class="ring-traits-group">
                  <h4>Feu</h4>
                  <div class="traits-ring-grid">
                    <div class="trait-item">
                      <span>Agilité:</span>
                      <span class="value">{{ getTraitValue('agilite') }}</span>
                      <div class="trait-buttons">
                        <button mat-button 
                                [disabled]="getTraitValue('agilite') <= 2"
                                (click)="decreaseTrait('agilite')"
                                matTooltip="Diminuer Agilité">
                          -
                        </button>
                        <button mat-button 
                                [disabled]="!canAfford(getTraitCost(getTraitValue('agilite'))) || isAtMaximum(getTraitValue('agilite'))"
                                (click)="improveTrait('agilite')"
                                matTooltip="Améliorer Agilité">
                          +
                        </button>
                      </div>
                      <span class="cost">({{ getTraitCost(getTraitValue('agilite')) }} XP)</span>
                    </div>
                    <div class="trait-item">
                      <span>Intelligence:</span>
                      <span class="value">{{ getTraitValue('intelligence') }}</span>
                      <div class="trait-buttons">
                        <button mat-button 
                                [disabled]="getTraitValue('intelligence') <= 2"
                                (click)="decreaseTrait('intelligence')"
                                matTooltip="Diminuer Intelligence">
                          -
                        </button>
                        <button mat-button 
                                [disabled]="!canAfford(getTraitCost(getTraitValue('intelligence'))) || isAtMaximum(getTraitValue('intelligence'))"
                                (click)="improveTrait('intelligence')"
                                matTooltip="Améliorer Intelligence">
                          +
                        </button>
                      </div>
                      <span class="cost">({{ getTraitCost(getTraitValue('intelligence')) }} XP)</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </mat-tab>

          <!-- Onglet Compétences -->
          <mat-tab label="Compétences">
            <div class="tab-content">
              <div class="skills-grid">
                <div class="skill-item" *ngFor="let skill of character().skills || []">
                  <span>{{ skill.name }}:</span>
                  <span class="value">{{ skill.rank }}</span>
                  <mat-chip [color]="skill.isSchoolSkill ? 'primary' : 'accent'" class="skill-type">
                    {{ skill.isSchoolSkill ? 'École' : 'Hors-École' }}
                  </mat-chip>
                  <button mat-button 
                          [disabled]="!canAfford(getSkillCost(skill)) || isAtMaximum(skill.rank)"
                          (click)="improveSkill(skill.name)"
                          [matTooltip]="'Améliorer ' + skill.name">
                    +
                  </button>
                  <span class="cost">({{ getSkillCost(skill) }} XP)</span>
                </div>
              </div>
            </div>
          </mat-tab>

          <!-- Onglet Avantages/Désavantages -->
          <mat-tab label="Avantages/Désavantages">
            <div class="tab-content">
              <div class="xp-impact-summary">
                <div class="xp-info">
                  <span class="advantage-cost">Coût avantages: {{ advantageXPCost() }} XP</span>
                  <span class="disadvantage-gain">Gain désavantages: +{{ disadvantageXPGain() }} XP</span>
                  <span class="net-impact">Impact net: {{ disadvantageXPGain() - advantageXPCost() }} XP</span>
                </div>
              </div>

              <mat-tab-group>
                <!-- Sous-onglet Avantages -->
                <mat-tab label="Sélectionner Avantages">
                  <div class="advantages-content">
                    <!-- Avantages sélectionnés -->
                    <div *ngIf="selectedAdvantages().length > 0" class="selected-section">
                      <h3>Avantages sélectionnés</h3>
                      <div class="selected-items">
                        <mat-chip-set>
                          <mat-chip *ngFor="let advantage of selectedAdvantages()" 
                                    (removed)="deselectAdvantage(advantage.id)">
                            {{ advantage.name }} ({{ advantage.cost }} XP)
                            X
                          </mat-chip>
                        </mat-chip-set>
                      </div>
                    </div>

                    <!-- Sélection par catégorie -->
                    <div class="category-section" *ngFor="let category of advantageCategories()">
                      <h4>{{ category }}</h4>
                      <div class="advantages-grid">
                        <mat-card *ngFor="let advantage of getAdvantagesByCategory(category)()" 
                                  class="advantage-card"
                                  [class.disabled]="availableXP() < advantage.cost">
                          <mat-card-header>
                            <mat-card-title>{{ advantage.name }}</mat-card-title>
                            <mat-card-subtitle>{{ advantage.cost }} XP</mat-card-subtitle>
                          </mat-card-header>
                          <mat-card-content>
                            <p>{{ advantage.description }}</p>
                          </mat-card-content>
                          <mat-card-actions>
                            <button mat-button 
                                    color="primary"
                                    (click)="selectAdvantage(advantage.id)"
                                    [disabled]="availableXP() < advantage.cost || isAdvantageSelected(advantage.id)">
                              Sélectionner
                            </button>
                          </mat-card-actions>
                        </mat-card>
                      </div>
                    </div>
                  </div>
                </mat-tab>

                <!-- Sous-onglet Désavantages -->
                <mat-tab label="Sélectionner Désavantages">
                  <div class="disadvantages-content">
                    <!-- Désavantages sélectionnés -->
                    <div *ngIf="selectedDisadvantages().length > 0" class="selected-section">
                      <h3>Désavantages sélectionnés</h3>
                      <div class="selected-items">
                        <mat-chip-set>
                          <mat-chip *ngFor="let disadvantage of selectedDisadvantages()" 
                                    (removed)="deselectDisadvantage(disadvantage.id)">
                            {{ disadvantage.name }} (+{{ disadvantage.xpGain }} XP)
                            X
                          </mat-chip>
                        </mat-chip-set>
                      </div>
                    </div>

                    <!-- Sélection par catégorie -->
                    <div class="category-section" *ngFor="let category of disadvantageCategories()">
                      <h4>{{ category }}</h4>
                      <div class="disadvantages-grid">
                        <mat-card *ngFor="let disadvantage of getDisadvantagesByCategory(category)()" 
                                  class="disadvantage-card">
                          <mat-card-header>
                            <mat-card-title>{{ disadvantage.name }}</mat-card-title>
                            <mat-card-subtitle>+{{ disadvantage.xpGain }} XP</mat-card-subtitle>
                          </mat-card-header>
                          <mat-card-content>
                            <p>{{ disadvantage.description }}</p>
                          </mat-card-content>
                          <mat-card-actions>
                            <button mat-button 
                                    color="accent"
                                    (click)="selectDisadvantage(disadvantage.id)"
                                    [disabled]="isDisadvantageSelected(disadvantage.id)">
                              Sélectionner
                            </button>
                          </mat-card-actions>
                        </mat-card>
                      </div>
                    </div>
                  </div>
                </mat-tab>
              </mat-tab-group>
            </div>
          </mat-tab>

          <!-- Onglet Équipement -->
          <mat-tab label="Équipement">
            <div class="tab-content">
              <div class="equipment-management">
                
                <!-- Argent disponible -->
                <div class="equipment-section">
                  <h4>Argent disponible</h4>
                  <p class="money-display">{{ getAvailableMoney() }} Koku</p>
                </div>
                
                <h3>Équipement actuel</h3>
                
                <!-- Armes -->
                <div class="equipment-section">
                  <h4>Armes</h4>
                  <div class="equipment-list">
                    <div *ngFor="let weapon of characterEquipment().weapons" class="equipment-item">
                      <span class="equipment-name">{{ weapon.name }}</span>
                      <span class="equipment-stats" *ngIf="weapon.damage">{{ weapon.damage }} dégâts</span>
                      <span class="equipment-cost" *ngIf="weapon.cost">{{ weapon.cost }} Koku</span>
                      <span class="equipment-description">{{ weapon.description }}</span>
                      <button mat-button (click)="sellEquipment(weapon.name, 'weapon')" 
                              matTooltip="Vendre ({{ Math.floor(parseInt(weapon.cost || '0') / 2) }} Koku)" 
                              class="sell-button">
                        Vendre
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Armure -->
                <div class="equipment-section">
                  <h4>Armure</h4>
                  <div class="equipment-item" *ngIf="currentArmor()">
                    <span class="equipment-name">{{ currentArmor()!.name }}</span>
                    <span class="equipment-stats">TN {{ currentArmor()!.TN }}, Réduction {{ currentArmor()!.reduction }}</span>
                    <span class="equipment-cost" *ngIf="currentArmor()!.cost">{{ currentArmor()!.cost }} Koku</span>
                    <span class="equipment-description">{{ currentArmor()!.description }}</span>
                    <button mat-button (click)="sellEquipment(currentArmor()!.name, 'armor')" 
                            matTooltip="Vendre ({{ Math.floor(parseInt(currentArmor()!.cost || '0') / 2) }} Koku)" 
                            class="sell-button"
                            *ngIf="currentArmor()!.name !== 'Pas d\'armure'">
                      Vendre
                    </button>
                  </div>
                </div>

                <!-- Objets -->
                <div class="equipment-section">
                  <h4>Objets et Équipements</h4>
                  <div class="equipment-list">
                    <div *ngFor="let item of characterEquipment().items" class="equipment-item">
                      <span class="equipment-name">{{ item.name }}</span>
                      <span class="equipment-cost" *ngIf="item.cost">{{ item.cost }} Koku</span>
                      <span class="equipment-description">{{ item.description }}</span>
                      <span class="equipment-special" *ngIf="item.special">{{ item.special }}</span>
                      <button mat-button (click)="sellEquipment(item.name, 'item')" 
                              matTooltip="Vendre ({{ Math.floor(parseInt(item.cost || '0') / 2) }} Koku)" 
                              class="sell-button">
                        Vendre
                      </button>
                    </div>
                  </div>
                </div>

                <h3>Marché d'équipement</h3>
                
                <!-- Acheter des armes -->
                <div class="equipment-section">
                  <h4>Armes disponibles</h4>
                  <div class="equipment-shop">
                    <div *ngFor="let weapon of shopWeapons" class="shop-item" [class.unaffordable]="!canAffordEquipment(weapon)">
                      <span class="equipment-name">{{ weapon.name }}</span>
                      <span class="equipment-stats" *ngIf="weapon.damage">{{ weapon.damage }} dégâts</span>
                      <span class="equipment-cost">{{ weapon.cost }} Koku</span>
                      <span class="equipment-description">{{ weapon.description }}</span>
                      <button mat-raised-button 
                              [disabled]="!canAffordEquipment(weapon)"
                              (click)="buyEquipment(weapon)"
                              class="buy-button">
                        Acheter
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Acheter des armures -->
                <div class="equipment-section">
                  <h4>Armures disponibles</h4>
                  <div class="equipment-shop">
                    <div *ngFor="let armor of shopArmor" class="shop-item" [class.unaffordable]="!canAffordEquipment(armor)">
                      <span class="equipment-name">{{ armor.name }}</span>
                      <span class="equipment-stats">TN {{ armor.TN }}, Réduction {{ armor.reduction }}</span>
                      <span class="equipment-cost">{{ armor.cost }} Koku</span>
                      <span class="equipment-description">{{ armor.description }}</span>
                      <button mat-raised-button 
                              [disabled]="!canAffordEquipment(armor)"
                              (click)="buyEquipment(armor)"
                              class="buy-button">
                        Acheter
                      </button>
                    </div>
                  </div>
                </div>

                <div class="equipment-note">
                  <p><strong>Note :</strong> L'équipement de base est déterminé par votre école. 
                  Vous pouvez acheter des équipements supplémentaires avec vos Koku.</p>
                </div>
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="previousStep()">Précédent</button>
        <button mat-raised-button color="primary" (click)="nextStep()">Suivant</button>
      </mat-card-actions>
    </mat-card>

    <!-- Étape 6: Sélection des Sorts (pour les Shugenjas) -->
    <mat-card *ngIf="currentStep() === 6">
      <mat-card-header>
        <mat-card-title>6. Sélection des Sorts</mat-card-title>
        <mat-card-subtitle *ngIf="canCastSpells()">
          <div>Votre école vous permet de lancer des sorts :</div>
          <div>
            • Rang 1 : {{ getSpellCountByRank(1) }}/{{ maxStartingSpells().rank1 }} sorts
          </div>
          <div>
            • Rang 2 : {{ getSpellCountByRank(2) }}/{{ maxStartingSpells().rank2 }} sorts
          </div>
          <div *ngIf="schoolAffinityDeficiency().affinity" class="affinity-info">
            Affinité : {{ schoolAffinityDeficiency().affinity }}
          </div>
          <div *ngIf="schoolAffinityDeficiency().deficiency" class="deficiency-info">
            Déficience : {{ schoolAffinityDeficiency().deficiency }} (interdits)
          </div>
        </mat-card-subtitle>
        <mat-card-subtitle *ngIf="!canCastSpells()">Votre école ne permet pas de lancer des sorts</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="canCastSpells()">
          <div class="spells-selection">
            <h3>Sorts Sélectionnés</h3>
            <div class="selected-spells" *ngIf="selectedSpells().length > 0">
              <mat-chip-set>
                <mat-chip 
                  *ngFor="let spell of selectedSpells()"
                  [removable]="true"
                  (removed)="removeSpell(spell.name)">
                  {{ spell.name }} ({{ spell.element }}, Niveau {{ spell.mastery }})
                  X
                </mat-chip>
              </mat-chip-set>
            </div>
            <p *ngIf="selectedSpells().length === 0" class="no-spells">Aucun sort sélectionné</p>

            <h3>Sorts Disponibles par Élément</h3>
            <mat-tab-group>
              <mat-tab *ngFor="let element of ['Air', 'Terre', 'Eau', 'Feu', 'Vide']; let i = index" 
                       [label]="element">
                <div class="spells-list">
                  <mat-card 
                    *ngFor="let spell of availableSpellsByElement()[element] || []"
                    class="spell-card"
                    (click)="addSpell(spell.name)">
                    <mat-card-header>
                      <mat-card-title>
                        {{ spell.name }}
                        <span *ngIf="spell.universal" class="universal-badge">[Universel]</span>
                      </mat-card-title>
                      <mat-card-subtitle>
                        Niveau {{ spell.mastery }} - {{ spell.element }}
                        <span *ngIf="spell.universal" class="universal-note">(Ignore les déficiences)</span>
                      </mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>
                      <div class="spell-details">
                        <p><strong>Portée:</strong> {{ spell.range }}</p>
                        <p><strong>Zone:</strong> {{ spell.area }}</p>
                        <p><strong>Durée:</strong> {{ spell.duration }}</p>
                        <p *ngIf="spell.raises"><strong>Augmentations:</strong> {{ spell.raises }}</p>
                        <p class="spell-description">{{ spell.description }}</p>
                      </div>
                    </mat-card-content>
                    <mat-card-actions>
                      <button mat-button 
                              color="primary"
                              [disabled]="!canAddMoreSpells()"
                              (click)="addSpell(spell.name)">
                        +
                        {{ canAddMoreSpells() ? 'Sélectionner' : 'Limite atteinte' }}
                      </button>
                    </mat-card-actions>
                  </mat-card>
                </div>
              </mat-tab>
            </mat-tab-group>
          </div>
        </div>
        <div *ngIf="!canCastSpells()" class="no-magic-info">
          <p>Votre école ne vous permet pas de lancer des sorts. Seuls les Shugenjas peuvent utiliser la magie élémentaire.</p>
          <p>Si vous souhaitez jouer un lanceur de sorts, retournez à l'étape 4 et choisissez une école de Shugenja.</p>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="previousStep()">Précédent</button>
        <button mat-raised-button color="primary" (click)="nextStep()">Suivant</button>
      </mat-card-actions>
    </mat-card>

    <!-- Étape 7: Résumé final -->
    <mat-card *ngIf="currentStep() === 7">
      <mat-card-header>
        <mat-card-title>7. Résumé du Personnage</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="summary-grid">
          <!-- Informations de base -->
          <div class="summary-section">
            <h3>Informations de Base</h3>
            <p><strong>Nom:</strong> {{ character().name }}</p>
            <p><strong>Âge:</strong> {{ character().age }} ans</p>
            <p><strong>Genre:</strong> {{ character().gender }}</p>
            <p><strong>Clan:</strong> {{ character().clan }}</p>
            <p><strong>Famille:</strong> {{ character().family }}</p>
            <p><strong>École:</strong> {{ character().school }}</p>
          </div>

          <!-- Statistiques dérivées -->
          <div class="summary-section">
            <h3>Statistiques</h3>
            <p><strong>Rang d'Insight:</strong> {{ insightRank() }}</p>
            <p><strong>Initiative:</strong> {{ initiative() }}</p>
            <p><strong>Honneur:</strong> {{ character().honor }}</p>
            <p><strong>Gloire:</strong> {{ character().glory }}</p>
            <p><strong>Statut:</strong> {{ character().status }}</p>
            <p><strong>XP Dépensés:</strong> {{ character().spentExperiencePoints }}/40</p>
          </div>

          <!-- Anneaux et Traits -->
          <div class="summary-section">
            <h3>Anneaux</h3>
            <div class="final-rings">
              <p>Terre: {{ calculatedRings().terre }}</p>
              <p>Eau: {{ calculatedRings().eau }}</p>
              <p>Air: {{ calculatedRings().air }}</p>
              <p>Feu: {{ calculatedRings().feu }}</p>
              <p>Vide: {{ calculatedRings().vide }}</p>
            </div>
          </div>

          <!-- Traits par Anneaux -->
          <div class="summary-section">
            <h3>Traits par Anneaux</h3>
            <div class="traits-by-rings">
              <div class="ring-group">
                <h4>Terre</h4>
                <p>Constitution: {{ character().traits?.constitution }}</p>
                <p>Volonté: {{ character().traits?.volonte }}</p>
              </div>
              <div class="ring-group">
                <h4>Eau</h4>
                <p>Force: {{ character().traits?.force }}</p>
                <p>Perception: {{ character().traits?.perception }}</p>
              </div>
              <div class="ring-group">
                <h4>Air</h4>
                <p>Réflexes: {{ character().traits?.reflexes }}</p>
                <p>Intuition: {{ character().traits?.intuition }}</p>
              </div>
              <div class="ring-group">
                <h4>Feu</h4>
                <p>Agilité: {{ character().traits?.agilite }}</p>
                <p>Intelligence: {{ character().traits?.intelligence }}</p>
              </div>
            </div>
          </div>

          <!-- Compétences -->
          <div class="summary-section">
            <h3>Compétences</h3>
            <div class="final-skills">
              <div *ngFor="let skill of character().skills" class="skill-line">
                <span>{{ skill.name }} {{ skill.rank }}</span>
                <span *ngIf="skill.isSchoolSkill" class="school-skill-icon" matTooltip="Compétence d'École">[École]</span>
              </div>
            </div>
          </div>

          <!-- Avantages et Désavantages -->
          <div class="summary-section" *ngIf="selectedAdvantages().length > 0 || selectedDisadvantages().length > 0">
            <h3>Avantages et Désavantages</h3>
            
            <div *ngIf="selectedAdvantages().length > 0" class="advantages-summary">
              <h4>Avantages ({{ advantageXPCost() }} XP)</h4>
              <div *ngFor="let advantage of selectedAdvantages()" class="advantage-line">
                <span><strong>{{ advantage.name }}</strong> ({{ advantage.cost }} XP)</span>
                <p class="description">{{ advantage.description }}</p>
              </div>
            </div>

            <div *ngIf="selectedDisadvantages().length > 0" class="disadvantages-summary">
              <h4>Désavantages (+{{ disadvantageXPGain() }} XP)</h4>
              <div *ngFor="let disadvantage of selectedDisadvantages()" class="disadvantage-line">
                <span><strong>{{ disadvantage.name }}</strong> (+{{ disadvantage.xpGain }} XP)</span>
                <p class="description">{{ disadvantage.description }}</p>
              </div>
            </div>
          </div>

          <!-- Sorts (si Shugenja) -->
          <div class="summary-section" *ngIf="selectedSpells().length > 0">
            <h3>Sorts</h3>
            <div class="spells-summary">
              <div *ngFor="let spell of selectedSpells()" class="spell-line">
                <span><strong>{{ spell.name }}</strong> ({{ spell.element }}, Niveau {{ spell.mastery }})</span>
                <div class="spell-details-summary">
                  <p><strong>Portée:</strong> {{ spell.range }} | <strong>Zone:</strong> {{ spell.area }} | <strong>Durée:</strong> {{ spell.duration }}</p>
                  <p class="spell-description">{{ spell.description }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Équipement -->
          <div class="summary-section">
            <h3>Équipement</h3>
            <div class="equipment-summary">
              
              <!-- Armes -->
              <div class="equipment-category" *ngIf="characterEquipment().weapons.length > 0">
                <h4>Armes</h4>
                <div *ngFor="let weapon of characterEquipment().weapons" class="equipment-summary-item">
                  <span><strong>{{ weapon.name }}</strong></span>
                  <span class="equipment-stats" *ngIf="weapon.damage">{{ weapon.damage }} dégâts, TN {{ weapon.TN }}</span>
                  <p class="equipment-description">{{ weapon.description }}</p>
                  <p class="equipment-special" *ngIf="weapon.special"><em>{{ weapon.special }}</em></p>
                </div>
              </div>

              <!-- Armure -->
              <div class="equipment-category" *ngIf="currentArmor() && currentArmor()!.name !== 'Pas d\'armure'">
                <h4>Armure</h4>
                <div class="equipment-summary-item">
                  <span><strong>{{ currentArmor()!.name }}</strong></span>
                  <span class="equipment-stats">TN {{ currentArmor()!.TN }}, Réduction {{ currentArmor()!.reduction }}</span>
                  <p class="equipment-description">{{ currentArmor()!.description }}</p>
                  <p class="equipment-special" *ngIf="currentArmor()!.special"><em>{{ currentArmor()!.special }}</em></p>
                </div>
              </div>

              <!-- Objets -->
              <div class="equipment-category" *ngIf="characterEquipment().items.length > 0">
                <h4>Objets et Équipements</h4>
                <div class="equipment-items-grid">
                  <div *ngFor="let item of characterEquipment().items" class="equipment-summary-item compact">
                    <span><strong>{{ item.name }}</strong></span>
                    <p class="equipment-description">{{ item.description }}</p>
                    <p class="equipment-special" *ngIf="item.special"><em>{{ item.special }}</em></p>
                  </div>
                </div>
              </div>

              <!-- Argent -->
              <div class="equipment-category">
                <h4>Argent</h4>
                <p><strong>{{ getAvailableMoney() }} Koku</strong></p>
              </div>
            </div>
          </div>

          <!-- Niveaux de blessure -->
          <div class="summary-section">
            <h3>Niveaux de Blessure</h3>
            <p>Sain: {{ woundLevels().healthy }}</p>
            <p>Égratignés: {{ woundLevels().nicked }}</p>
            <p>Éraflés: {{ woundLevels().grazed }}</p>
            <p>Blessés: {{ woundLevels().hurt }}</p>
            <p>Estropiés: {{ woundLevels().injured }}</p>
            <p>Abattus: {{ woundLevels().crippled }}</p>
            <p>K.O.: {{ woundLevels().down }}</p>
            <p>Mort: {{ woundLevels().out }}</p>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button (click)="previousStep()">Précédent</button>
        <button mat-raised-button color="warn" (click)="resetCharacter()">Recommencer</button>
        <button mat-raised-button color="primary" (click)="exportCharacter()">Exporter JSON</button>
      </mat-card-actions>
    </mat-card>

    <!-- Panneau des statistiques en temps réel -->
    <mat-card class="stats-display" *ngIf="currentStep() < 7">
      <mat-card-header>
        <mat-card-title>Statistiques Actuelles</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stats-grid">
          <div class="stat-section">
            <h4>Anneaux</h4>
            <p>Terre: {{ calculatedRings().terre }}</p>
            <p>Eau: {{ calculatedRings().eau }}</p>
            <p>Air: {{ calculatedRings().air }}</p>
            <p>Feu: {{ calculatedRings().feu }}</p>
            <p>Vide: {{ calculatedRings().vide }}</p>
          </div>
          
          <div class="stat-section">
            <h4>Statistiques Dérivées</h4>
            <p>Rang d'Insight: {{ insightRank() }}</p>
            <p>Initiative: {{ initiative() }}</p>
            <p>Honneur: {{ character().honor }}</p>
            <p>XP Restants: {{ availableXP() }}</p>
          </div>

          <div class="stat-section">
            <h4>Combat (ND)</h4>
            <p>ND Corps à Corps: {{ combatStats().meleeDefenseND }}</p>
            <p>ND Esquive: {{ combatStats().dodgeND }}</p>
            <p>Initiative Base: {{ combatStats().baseInitiative }}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Navigation -->
  <div class="navigation-footer">
    <mat-card>
      <mat-card-content>
        <div class="step-indicator">
          <div class="progress-bar">
            <mat-progress-bar mode="determinate" [value]="(currentStep() / 6) * 100"></mat-progress-bar>
          </div>
          <div class="steps">
            <mat-chip-set>
              <mat-chip 
                *ngFor="let step of [1, 2, 3, 4, 5, 6]"
                [color]="currentStep() === step ? 'primary' : (currentStep() > step ? 'accent' : '')"
                (click)="goToStep(step)"
                [class.clickable]="step < currentStep()">
                {{ step }}
              </mat-chip>
            </mat-chip-set>
          </div>
          <div class="step-labels">
            <span [class.active]="currentStep() === 1">Info</span>
            <span [class.active]="currentStep() === 2">Clan</span>
            <span [class.active]="currentStep() === 3">Famille</span>
            <span [class.active]="currentStep() === 4">École</span>
            <span [class.active]="currentStep() === 5">XP</span>
            <span [class.active]="currentStep() === 6">Sorts</span>
            <span [class.active]="currentStep() === 7">Résumé</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
